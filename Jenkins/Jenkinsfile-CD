pipeline {
    agent any
    

    parameters {
        string(name: 'customers-service', defaultValue: 'main')
        string(name: 'genai-service', defaultValue: 'main')
        string(name: 'vets-service', defaultValue: 'main')
        string(name: 'visits-service', defaultValue: 'main')
    }

    environment {
        REPO_URL = 'https://github.com/22127475/spring-petclinic-microservices.git'
        IMAGE_NAME = '22127475/spring-petclinic'
    }

    stages {
        stage('Deploy services') {
            steps {
                script {
                    // Dựng danh sách dịch vụ với các nhánh của từng dịch vụ
                    services = [
                        [name: 'customers-service', branch: params['customers-service']],
                        [name: 'visits-service', branch: params['visits-service']], 
                        [name: 'vets-service', branch: params['vets-service']],
                        [name: 'genai-service', branch: params['genai-service']]
                    ]

                    
                    tags = []
                    for (service in services) {
                        def tag = service.branch == 'main' ? 'latest' : bat(script: '''
    for /f "tokens=1" %%A in ('git ls-remote https://github.com/22127475/spring-petclinic-microservices.git refs/heads/dev_vets_service') do echo %%A
''', returnStdout: true).trim()
                        tags.add(tag)
                        echo "tags for ${service.name}: ${tag}"
                    }
                }
            }
        }

        stage('Pull images') {
            steps {
                script {
                    
                    for (int i = 0; i < services.size(); i++) {
                        def service = services[i]
                        def tag = tags[i]
                        
                        bat "docker image pull ${IMAGE_NAME}-${service.name}:${tag}"
                        echo "pulled image: ${IMAGE_NAME}-${service.name}:${tag}"
                    }
                }
            }
        }        
    }
}
