pipeline {
    agent any
    environment {
            DOCKERHUB_CREDENTIALS_ID = 'Docker_Jenkins_CD'
            DOCKER_REGISTRY        = '22127475'
        }

        stage('Build and Push Images to Docker Hub') {
            when {
                tag "*"
            }
            steps {
                script {
                    docker.withRegistry("https://index.docker.io/v1/", env.DOCKERHUB_CREDENTIALS_ID) { 
                        try {
                            def output = bat(script: 'git describe --tags', returnStdout: true).trim()
                            def lines = output.readLines()
                            def LATEST_TAG = lines[lines.size() - 1]
                            echo "Building Docker image for tag ${LATEST_TAG}"
                            

                            def mvnCommand = "./mvnw.cmd clean install -P buildDocker -DskipTests " +
                                "-Ddocker.image.prefix=${env.DOCKER_REGISTRY} " +
                                "-Ddocker.image.tag.commit=${LATEST_TAG} " +
                                "-Dcontainer.build.extraarg=\"--push\""

                            bat mvnCommand
                            } catch (e) {
                                echo "Build failed: ${e.getMessage()}"
                                error("Docker image build failed")
                            }
                    }
                }
            }
        }
    }
}
